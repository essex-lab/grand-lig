<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Example 3: Bulk Water &mdash; grandlig 1.0.2-dev-lig documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="_static/graphviz.css?v=fd3f3429" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=f283550b"></script>
        <script src="_static/doctools.js?v=9a2dae69"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Example 2: Scytalone Dehydratase" href="examples.scytalone.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            grandlig
          </a>
              <div class="version">
                1.0.2
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">grandlig : Grand Canonical Sampling of Small Molecules in OpenMM</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Change Log</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="examples.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="examples.bpti.html">Example 1: Bovine Pancreatic Trypsin Inhibitor</a></li>
<li class="toctree-l2"><a class="reference internal" href="examples.scytalone.html">Example 2: Scytalone Dehydratase</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Example 3: Bulk Water</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">grandlig</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="examples.html">Examples</a></li>
      <li class="breadcrumb-item active">Example 3: Bulk Water</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/examples.water.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="example-3-bulk-water">
<h1>Example 3: Bulk Water<a class="headerlink" href="#example-3-bulk-water" title="Link to this heading">ÔÉÅ</a></h1>
<p>This example is slightly different in that bulk water is sampled over the entire system volume.
This is not an efficient use of GCMC for water sampling, but can sometimes be useful for testing purposes.
Note the use of the <code class="docutils literal notranslate"><span class="pre">StandardGCMCSystemSampler</span></code> object, rather than <code class="docutils literal notranslate"><span class="pre">StandardGCMCSphereSampler</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Description</span>
<span class="sd">-----------</span>
<span class="sd">Example script of how to run GCMC/MD in OpenMM for a simple water system</span>

<span class="sd">Note that this simulation is only an example, and is not long enough</span>
<span class="sd">to see equilibrated behaviour</span>

<span class="sd">Marley Samways</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">openmm.app</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">openmm</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">openmm.unit</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">stdout</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">openmmtools.integrators</span> <span class="kn">import</span> <span class="n">BAOABIntegrator</span>

<span class="kn">import</span> <span class="nn">grand</span>

<span class="c1"># Load in a water box PDB...</span>
<span class="n">pdb</span> <span class="o">=</span> <span class="n">PDBFile</span><span class="p">(</span><span class="s1">&#39;water_box-eq.pdb&#39;</span><span class="p">)</span>

<span class="c1"># Add ghost waters,</span>
<span class="n">pdb</span><span class="o">.</span><span class="n">topology</span><span class="p">,</span> <span class="n">pdb</span><span class="o">.</span><span class="n">positions</span><span class="p">,</span> <span class="n">ghosts</span> <span class="o">=</span> <span class="n">grand</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">add_ghosts</span><span class="p">(</span><span class="n">pdb</span><span class="o">.</span><span class="n">topology</span><span class="p">,</span>
                                                             <span class="n">pdb</span><span class="o">.</span><span class="n">positions</span><span class="p">,</span>
                                                             <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                                             <span class="n">pdb</span><span class="o">=</span><span class="s1">&#39;water-ghosts.pdb&#39;</span><span class="p">)</span>

<span class="n">ff</span> <span class="o">=</span> <span class="n">ForceField</span><span class="p">(</span><span class="s1">&#39;tip3p.xml&#39;</span><span class="p">)</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">createSystem</span><span class="p">(</span><span class="n">pdb</span><span class="o">.</span><span class="n">topology</span><span class="p">,</span>
                         <span class="n">nonbondedMethod</span><span class="o">=</span><span class="n">PME</span><span class="p">,</span>
                         <span class="n">nonbondedCutoff</span><span class="o">=</span><span class="mf">12.0</span><span class="o">*</span><span class="n">angstroms</span><span class="p">,</span>
                         <span class="n">switchDistance</span><span class="o">=</span><span class="mf">10.0</span><span class="o">*</span><span class="n">angstroms</span><span class="p">,</span>
                         <span class="n">constraints</span><span class="o">=</span><span class="n">HBonds</span><span class="p">)</span>

<span class="c1"># Create GCMC sampler object - sampling the entire simulation volume</span>
<span class="n">gcmc_mover</span> <span class="o">=</span> <span class="n">grand</span><span class="o">.</span><span class="n">samplers</span><span class="o">.</span><span class="n">StandardGCMCSystemSampler</span><span class="p">(</span><span class="n">system</span><span class="o">=</span><span class="n">system</span><span class="p">,</span>
                                                      <span class="n">topology</span><span class="o">=</span><span class="n">pdb</span><span class="o">.</span><span class="n">topology</span><span class="p">,</span>
                                                      <span class="n">temperature</span><span class="o">=</span><span class="mi">300</span><span class="o">*</span><span class="n">kelvin</span><span class="p">,</span>
                                                      <span class="n">boxVectors</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pdb</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">getPeriodicBoxVectors</span><span class="p">()),</span>
                                                      <span class="n">log</span><span class="o">=</span><span class="s1">&#39;water-gcmc.log&#39;</span><span class="p">,</span>
                                                      <span class="n">dcd</span><span class="o">=</span><span class="s1">&#39;water-raw.dcd&#39;</span><span class="p">,</span>
                                                      <span class="n">rst</span><span class="o">=</span><span class="s1">&#39;water-gcmc.rst7&#39;</span><span class="p">,</span>
                                                      <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Langevin integrator</span>
<span class="n">integrator</span> <span class="o">=</span> <span class="n">BAOABIntegrator</span><span class="p">(</span><span class="mi">300</span><span class="o">*</span><span class="n">kelvin</span><span class="p">,</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">picosecond</span><span class="p">,</span> <span class="mf">0.002</span><span class="o">*</span><span class="n">picoseconds</span><span class="p">)</span>

<span class="n">platform</span> <span class="o">=</span> <span class="n">Platform</span><span class="o">.</span><span class="n">getPlatformByName</span><span class="p">(</span><span class="s1">&#39;CUDA&#39;</span><span class="p">)</span>
<span class="n">platform</span><span class="o">.</span><span class="n">setPropertyDefaultValue</span><span class="p">(</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;mixed&#39;</span><span class="p">)</span>

<span class="n">simulation</span> <span class="o">=</span> <span class="n">Simulation</span><span class="p">(</span><span class="n">pdb</span><span class="o">.</span><span class="n">topology</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">integrator</span><span class="p">,</span> <span class="n">platform</span><span class="p">)</span>
<span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setPositions</span><span class="p">(</span><span class="n">pdb</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span>
<span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setVelocitiesToTemperature</span><span class="p">(</span><span class="mi">300</span><span class="o">*</span><span class="n">kelvin</span><span class="p">)</span>
<span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setPeriodicBoxVectors</span><span class="p">(</span><span class="o">*</span><span class="n">pdb</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">getPeriodicBoxVectors</span><span class="p">())</span>

<span class="c1"># Switch off ghost waters and in sphere</span>
<span class="n">gcmc_mover</span><span class="o">.</span><span class="n">initialise</span><span class="p">(</span><span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">ghosts</span><span class="p">)</span>

<span class="c1"># Equilibrate water distribution - 10k moves over 5 ps</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Equilibration...&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">):</span>
    <span class="c1"># Carry out 200 moves every 100 fs</span>
    <span class="n">gcmc_mover</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
    <span class="n">simulation</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2"> equilibration GCMC moves accepted. N = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gcmc_mover</span><span class="o">.</span><span class="n">n_accepted</span><span class="p">,</span>
                                                               <span class="n">gcmc_mover</span><span class="o">.</span><span class="n">n_moves</span><span class="p">,</span>
                                                               <span class="n">gcmc_mover</span><span class="o">.</span><span class="n">N</span><span class="p">))</span>

<span class="c1"># Add StateDataReporter for production</span>
<span class="n">simulation</span><span class="o">.</span><span class="n">reporters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">StateDataReporter</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span>
                                              <span class="mi">1000</span><span class="p">,</span>
                                              <span class="n">step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                              <span class="n">potentialEnergy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                              <span class="n">temperature</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                              <span class="n">volume</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="c1"># Reset GCMC statistics</span>
<span class="n">gcmc_mover</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

<span class="c1"># Run simulation</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Production&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">):</span>
    <span class="c1"># Carry out 100 GCMC moves per 1 ps of MD</span>
    <span class="n">simulation</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
    <span class="n">gcmc_mover</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="c1"># Write data out</span>
    <span class="n">gcmc_mover</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">simulation</span><span class="p">)</span>

<span class="c1">#</span>
<span class="c1"># Need to process the trajectory for visualisation</span>
<span class="c1">#</span>

<span class="c1"># Move ghost waters away</span>
<span class="n">grand</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">shift_ghost_waters</span><span class="p">(</span><span class="n">ghost_file</span><span class="o">=</span><span class="s1">&#39;gcmc-ghost-wats.txt&#39;</span><span class="p">,</span>
                               <span class="n">topology</span><span class="o">=</span><span class="s1">&#39;water-ghosts.pdb&#39;</span><span class="p">,</span>
                               <span class="n">trajectory</span><span class="o">=</span><span class="s1">&#39;water-raw.dcd&#39;</span><span class="p">,</span>
                               <span class="n">output</span><span class="o">=</span><span class="s1">&#39;water-gcmc.dcd&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="examples.scytalone.html" class="btn btn-neutral float-left" title="Example 2: Scytalone Dehydratase" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Essex Group, School of Chemistry, University of Southampton.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>